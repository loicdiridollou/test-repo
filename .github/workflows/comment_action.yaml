name: Comment Commands to Trigger CI
on:
  issue_comment:
    types: created

permissions:
  checks: write

env:
  RUN_COMMAND: '{"/pandas_nightly": "pytest --nightly", "/pyright_strict": "pyright_strict", "/mypy_nightly": "mypy --mypy_nightly"}'
  DISPLAY_COMMAND: '{"/pandas_nightly": "Run pandas nightly tests", "/pyright_strict": "Pyright strict tests", "/mypy_nightly": "Mypy nightly tests"}'

jobs:
  pandas_nightly:
    runs-on: ubuntu-latest
    env:
      COMMENT: "/pandas_nightly"
    timeout-minutes: 10
    if: (github.event.issue.pull_request) && contains(fromJSON('["/pandas_nightly", "/pyright_strict"]'), github.event.comment.body) # == env.COMMENT

    steps:
      # - uses: actions/checkout@v4

      # - name: Install project dependencies
      #   uses: ./.github/setup
      #   with:
      #     os: ubuntu-latest
      #     python-version: "3.11"
      #
      # - name: Run pytest (against pandas nightly)
      #   id: tests-step
      #   run: poetry run poe pytest --nightly

      - name: Run pytest (against pandas nightly)
        id: tests-step
        run: echo ${{ github.event.comment.body }}; echo ${{ fromJSON(env.RUN_COMMAND)[github.evenv.comment.body] }}; echo ${{ fromJSON(env.DISPLAY_COMMAND)[github.evenv.comment.body] }}

      # - name: Get head sha and store value
      #   if: always()
      #   id: get-sha
      #   uses: actions/github-script@v7
      #   with:
      #     github-token: ${{ secrets.GITHUB_TOKEN }}
      #     script: |
      #       const pr = await github.rest.pulls.get({
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         pull_number: ${{ github.event.issue.number }}
      #       })
      #       core.setOutput('sha', pr.data.head.sha)
      #
      # - name: Report results of the tests and publish
      #   if: always()
      #   uses: actions/github-script@v7
      #   with:
      #     github-token: ${{ secrets.GITHUB_TOKEN }}
      #     script: |
      #       github.rest.checks.create({
      #         name: 'Pandas nightly tests',
      #         head_sha: '${{ steps.get-sha.outputs.sha }}',
      #         status: 'completed',
      #         conclusion: '${{ steps.tests-step.outcome }}',
      #         output: {
      #           title: 'Run pandas nightly tests',
      #           summary: 'Results: ${{ steps.tests-step.outcome }}',
      #           text: 'See the actions run at ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}',
      #         },
      #         owner: context.repo.owner,
      #         repo: context.repo.repo
      #       })
